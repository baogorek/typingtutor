<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <style>
      body {
        background-image: url('http://blog.hostbaby.com/wp-content/uploads/2013/07/antiquepaper_1920x1234.jpg')
      }
    .button {
      display: inline-block;
      padding: 15px 25px;
      font-size: 24px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      outline: none;
      color: #fff;
      background-color: #4CAF50;
      border: none;
      border-radius: 15px;
      box-shadow: 0 9px #999;
    }
    
    .button:hover {background-color: #3e8e41}
    
    .button:active {
      background-color: #3e8e41;
      box-shadow: 0 5px #666;
      transform: translateY(4px);
    }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script type="text/javascript">
      var config = {
        apiKey: "AIzaSyDFLZi6KGXURw8nibcJhGhN23-4vbMNV24",
        authDomain: "typingtutor-9f7e9.firebaseapp.com",
        databaseURL: "https://typingtutor-9f7e9.firebaseio.com",
        projectId: "typingtutor-9f7e9",
        storageBucket: "typingtutor-9f7e9.appspot.com",
        messagingSenderId: "736144011972"
      };
      firebase.initializeApp(config);

      initApp = function() {

        document.getElementById('firebase-token').style.display = 'none';
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            
            document.getElementById('welcome').textContent =
              'Welcome to typingtutor, ' + user.displayName + '!';
            
            var dbRefObject = firebase.database().ref().child("user_info/" + user.uid);
            var typingData;
            var exerciseInfo = {};

            dbRefObject.on('value',
              function(snapshot) {

                // data manipulation
                typingData = snapshot.val();
                Object.entries(typingData).forEach(([key, value]) => {

                  if (value['r_file'] && value['expression_group']) {
                    var new_key = value['r_file'] + ':' + value['expression_group'];
                    var new_value ={};
                    new_value["datetime"] = new Date(parseInt(key.substring(1)));
                    new_value["wpm"] = value["wpm"];
                    if (exerciseInfo[new_key]) {
                      exerciseInfo[new_key] = exerciseInfo[new_key].concat(new_value);
                    } else {
                      exerciseInfo[new_key] = [new_value];
                    }
                  }
                });
                // End transpose object
 
                var timestamps = Object.keys(typingData).sort().reverse();
                var timeLastEx = new Date(parseInt(timestamps[0].substring(1)));
                var lastTry = 'The last time you played was on ' + timeLastEx +
                  '<br/><br/> The file was ' + 
                              typingData[timestamps[0]]['r_file'] +
                              '<br/><br/> The expression group played was ' +
                              typingData[timestamps[0]]['expression_group'] +
                              '\n with wpm: ' + typingData[timestamps[0]]['wpm'];


                var last_object = typingData[timestamps[0]];
                var last_key = last_object['r_file'] + ':' + last_object['expression_group'];

                document.getElementById('last-try').innerHTML = lastTry + '\n\n' +
                  JSON.stringify(exerciseInfo[last_key]);

                var canvas = d3.select('last-try')
                               .append('svg')
                               .attr('width', 500)
                               .attr('height', 500)
                               .append('g')
                               .attr('transform', 'translate(20, 0)');

                var bars = canvas.selectAll('rect')
                                 .data(exerciseInfo[last_key])
                                 .enter()
                                   .append('rect')
                                   .attr('width', function(d) { return d.wpm })
                                   .attr('height', 50)
                                   .attr('fill', function(d) {return colorscale(d.wmp)})
                                   .attr('y', function(d, i) { return i * 100; })
                //canvas.append('g')
                //      .attr('transform', 'translate(400, 0)')
                //      .call('axis')
               
                document.getElementById('history').innerHTML = "";
                var myList = d3.select("#history")
                  .append("ul");
                
                myList.selectAll("li")
                  .data(Object.keys(exerciseInfo))
                  .enter()
                    .append("li")
                    .text(function(d) { return d;})
                      .append("ul")
                      .selectAll("li")
                      .data(function(d) { return exerciseInfo[d] })
                      .enter()
                        .append("li")
                        .text(function(d) { return d.datetime.toLocaleString() +
                                           ': ' + d.wpm.toString();} );


                });
          } else { // user needs to sign in
            window.location = "https://baogorek.github.io/typingtutor/"
          }
        });
      };

      function copyToClipboard(text) {
          window.prompt("Copy to clipboard: Ctrl+C, Enter", text);
      };

      function refreshToken() {
       firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            user.getToken().then(function(accessToken) {
              //document.getElementById('firebase-token').textContent = accessToken;
              copyToClipboard("{\"token\":\"" + accessToken +
              "\", \"userid\":\"" + firebase.auth().currentUser.uid + "\"}")
            });
          };
        });
      };
    </script>
  </head>
  <body onload="initApp();">
    <h1><div id = "welcome"></div></h1>

    <div id="firebase-token"></div>

    <button class="button" id="copy-token"
      onclick='refreshToken();'>
      Click to copy authentication metadata
    </button>

    <h2> Your last try </h2>
    <div id="last-try"></div>

    <h2> Your typingtutor history </h2>
    <div id="history"></div>

  </body>
</html>
